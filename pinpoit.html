<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Th·ª≠ Th√°ch Pinpoint | Bang Nguyen</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: #f0f2f5;
        }
        .clue-box {
            transition: all 0.5s ease;
            transform-origin: top;
        }
        .clue-box.hidden-clue .clue-text {
            opacity: 0;
            transform: translateY(-10px);
        }
        .clue-box.revealed .clue-text {
            opacity: 1;
            transform: translateY(0);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- Loading Modal for AI Generation -->
    <div id="loading-modal" class="fixed inset-0 z-50 hidden items-center justify-center" style="background-color: rgba(0,0,0,0.7);">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-sm text-center">
            <div class="loader mx-auto"></div>
            <p class="mt-4 text-gray-600 font-semibold">ƒêang t·∫°o c√¢u ƒë·ªë m·ªõi...</p>
        </div>
    </div>


    <div id="game-container" class="w-full max-w-md mx-auto">
        <header class="text-center mb-6">
            <h1 class="text-4xl font-extrabold text-gray-800">Th·ª≠ Th√°ch Pinpoint</h1>
            <p class="text-gray-500">M·ªôt c√¢u ƒë·ªë logic b·ªüi B·∫±ng Nguy·ªÖn</p>
        </header>

        <main class="bg-white rounded-xl shadow-lg p-6">
            <div id="category" class="text-center mb-4 text-sm font-semibold text-gray-500 uppercase tracking-wider min-h-[20px]"></div>
            
            <div id="clues-container" class="space-y-2 mb-4">
                <!-- Clues will be generated here -->
            </div>

            <!-- Action Buttons Container -->
            <div class="grid grid-cols-2 gap-2 mb-4">
                <button id="reveal-clue-button" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg transition-colors">L·∫≠t m·ªü g·ª£i √Ω</button>
                <!-- NEW: Show Answer Button -->
                <button id="show-answer-button" class="w-full bg-orange-200 hover:bg-orange-300 text-orange-800 font-bold py-2 px-4 rounded-lg transition-colors opacity-50 cursor-not-allowed" disabled>Hi·ªÉn th·ªã ƒë√°p √°n</button>
            </div>
            
            <div id="feedback" class="text-center text-sm font-semibold mb-4 min-h-[20px]"></div>
            
            <div class="relative">
                <input type="text" id="guess-input" placeholder="Nh·∫≠p ƒë√°p √°n c·ªßa b·∫°n..." class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:outline-none focus:border-blue-500" disabled>
                <button id="guess-button" class="absolute right-2 top-1/2 -translate-y-1/2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors" disabled>ƒêo√°n</button>
            </div>
            
            <div id="wrong-guesses-container" class="mt-4 text-center text-xs text-gray-400 min-h-[16px]">
                <!-- Wrong guesses will be shown here -->
            </div>
        </main>
    </div>

    <!-- Win Modal -->
    <div id="win-modal" class="fixed inset-0 z-50 hidden items-center justify-center" style="background-color: rgba(0,0,0,0.7);">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-sm text-center">
            <h2 class="text-2xl font-bold mb-2 text-yellow-500">üéâ ƒêo√°n ƒê√∫ng R·ªìi! üéâ</h2>
            <p class="mb-4 text-gray-600">B·∫°n ƒë√£ "pinpoint" th√†nh c√¥ng ƒë√°p √°n.</p>
            <div class="bg-gray-100 rounded-lg p-4 mb-6">
                <p class="text-sm text-gray-500">K·∫øt qu·∫£ c·ªßa b·∫°n:</p>
                <p id="result-grid" class="text-3xl font-bold tracking-widest"></p>
            </div>
            <button id="share-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md mb-2 transition-colors">Sao ch√©p & Chia s·∫ª</button>
            <button id="play-again-button" class="w-full mt-2 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Ch∆°i L·∫°i</button>
        </div>
    </div>
    
    <script>
        const fallbackPuzzles = [
            { "category": "QU·ªêC GIA N√ÄO?", "clues": ["Ph·ªü", "√Åo d√†i", "H√† N·ªôi", "N√≥n l√°", "V·ªãnh H·∫° Long"], "answer": "vi·ªát nam" },
            { "category": "NH√ÇN V·∫¨T L·ªäCH S·ª¨ N√ÄO?", "clues": ["Th·ªëng nh·∫•t ƒë·∫•t n∆∞·ªõc", "Ho√†ng ƒë·∫ø ƒë·∫ßu ti√™n", "Ch·ªëng qu√¢n Nam H√°n", "Tr·∫≠n B·∫°ch ƒê·∫±ng", "X∆∞ng v∆∞∆°ng"], "answer": "ng√¥ quy·ªÅn" }
        ];

        let currentPuzzle;
        let revealedCluesCount;
        let wrongGuesses;
        
        const loadingModalEl = document.getElementById('loading-modal');
        const categoryEl = document.getElementById('category');
        const cluesContainerEl = document.getElementById('clues-container');
        const feedbackEl = document.getElementById('feedback');
        const guessInputEl = document.getElementById('guess-input');
        const guessButtonEl = document.getElementById('guess-button');
        const wrongGuessesEl = document.getElementById('wrong-guesses-container');
        const winModalEl = document.getElementById('win-modal');
        const resultGridEl = document.getElementById('result-grid');
        const shareButtonEl = document.getElementById('share-button');
        const revealClueButtonEl = document.getElementById('reveal-clue-button');
        const playAgainButtonEl = document.getElementById('play-again-button');
        const showAnswerButtonEl = document.getElementById('show-answer-button'); // NEW: Get the answer button

        async function getNewPuzzle() {
            loadingModalEl.classList.remove('hidden');
            loadingModalEl.classList.add('flex');
            try {
                const apiKey = "AIzaSyAdQojSqdgD3qollJhmSl-3emR88k7H9gQ"; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const systemPrompt = `B·∫°n l√† m·ªôt ng∆∞·ªùi t·∫°o c√¢u ƒë·ªë cho tr√≤ ch∆°i 'Pinpoint'. Nhi·ªám v·ª• c·ªßa b·∫°n l√† t·∫°o ra M·ªòT c√¢u ƒë·ªë ch·∫•t l∆∞·ª£ng cao ·ªü ƒë·ªãnh d·∫°ng JSON h·ª£p l·ªá. To√†n b·ªô n·ªôi dung (category, clues, answer) PH·∫¢I L√Ä TI·∫æNG VI·ªÜT. Tu√¢n th·ªß nghi√™m ng·∫∑t c√°c quy t·∫Øc sau: 1. **'category' (ch·ªß ƒë·ªÅ) PH·∫¢I l√† m·ªôt c√¢u h·ªèi v·ªÅ 'answer' (ƒë√°p √°n).** V√≠ d·ª•: n·∫øu ƒë√°p √°n l√† "s∆°n t√πng mtp", ch·ªß ƒë·ªÅ ph·∫£i l√† "CA Sƒ® N√ÄO?". 2. **'answer' (ƒë√°p √°n) PH·∫¢I l√† t·ª´ kh√≥a ho·∫∑c t√™n ri√™ng duy nh·∫•t k·∫øt n·ªëi t·∫•t c·∫£ c√°c g·ª£i √Ω.** Ph·∫£i l√† ch·ªØ th∆∞·ªùng, kh√¥ng d·∫•u. 3. **5 'clues' (g·ª£i √Ω) PH·∫¢I nh·∫•t qu√°n v·ªÅ m·∫∑t logic v√† c√πng m·ªôt lo·∫°i.** V√≠ d·ª•: t·∫•t c·∫£ ƒë·ªÅu l√† b√†i h√°t, ho·∫∑c t·∫•t c·∫£ ƒë·ªÅu l√† th√†nh ph·ªë. 4. **T·∫•t c·∫£ n·ªôi dung ph·∫£i l√† ti·∫øng Vi·ªát.**`;
                const userQuery = "T·∫°o m·ªôt c√¢u ƒë·ªë Pinpoint m·ªõi, ch·∫•t l∆∞·ª£ng cao v√† tu√¢n th·ªß t·∫•t c·∫£ c√°c quy t·∫Øc.";
                const payload = {
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    contents: [{ parts: [{ text: userQuery }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: { type: "OBJECT", properties: { "category": { "type": "STRING" }, "clues": { "type": "ARRAY", "items": { "type": "STRING" } }, "answer": { "type": "STRING" } }, required: ["category", "clues", "answer"] }
                    }
                };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                const result = await response.json();
                return JSON.parse(result.candidates[0].content.parts[0].text);
            } catch (error) {
                console.error("Failed to fetch puzzle from Gemini API:", error);
                return fallbackPuzzles[Math.floor(Math.random() * fallbackPuzzles.length)];
            } finally {
                loadingModalEl.classList.add('hidden');
                loadingModalEl.classList.remove('flex');
            }
        }

        function levenshteinDistance(a, b) {
            if(a.length === 0) return b.length; if(b.length === 0) return a.length;
            const m = Array(b.length + 1).fill(null).map(() => Array(a.length + 1).fill(null));
            for(let i=0; i<=a.length; i+=1){m[0][i]=i;} for(let j=0; j<=b.length; j+=1){m[j][0]=j;}
            for(let j=1; j<=b.length; j+=1){ for(let i=1; i<=a.length; i+=1){
                const indicator = a[i-1]===b[j-1]?0:1;
                m[j][i]=Math.min(m[j][i-1]+1, m[j-1][i]+1, m[j-1][i-1]+indicator);
            }} return m[b.length][a.length];
        }

        async function initGame() {
            currentPuzzle = await getNewPuzzle();
            revealedCluesCount = 1; wrongGuesses = [];
            winModalEl.classList.add('hidden'); winModalEl.classList.remove('flex');
            feedbackEl.textContent = ''; guessInputEl.value = ''; wrongGuessesEl.textContent = '';
            guessInputEl.disabled = false; guessButtonEl.disabled = false;
            render();
        }

        function render() {
            categoryEl.textContent = currentPuzzle.category;
            cluesContainerEl.innerHTML = '';
            const colors = ["bg-blue-200", "bg-blue-300", "bg-blue-400", "bg-blue-500", "bg-blue-600"];
            currentPuzzle.clues.forEach((clue, index) => {
                const isRevealed = index < revealedCluesCount;
                const clueDiv = document.createElement('div');
                clueDiv.className = `clue-box ${colors[index]} p-4 rounded-lg text-center font-bold text-gray-800 ${isRevealed ? 'revealed' : 'hidden-clue'}`;
                const clueText = document.createElement('span');
                clueText.className = 'clue-text transition-all duration-500';
                clueText.textContent = isRevealed ? clue : `G·ª£i √Ω ${index + 1}`;
                clueDiv.appendChild(clueText); cluesContainerEl.appendChild(clueDiv);
            });
            
            // Update reveal and answer button states
            if(revealedCluesCount >= 5){
                revealClueButtonEl.disabled=true; revealClueButtonEl.textContent="ƒê√£ h·∫øt g·ª£i √Ω"; revealClueButtonEl.classList.add('opacity-50','cursor-not-allowed');
                // NEW: Enable show answer button
                showAnswerButtonEl.disabled = false; showAnswerButtonEl.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                revealClueButtonEl.disabled=false; revealClueButtonEl.textContent="L·∫≠t m·ªü g·ª£i √Ω"; revealClueButtonEl.classList.remove('opacity-50','cursor-not-allowed');
                // NEW: Disable show answer button
                showAnswerButtonEl.disabled = true; showAnswerButtonEl.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        function handleGuess() {
            const guess = guessInputEl.value.trim().toLowerCase();
            if (!guess) return;
            const distance = levenshteinDistance(guess, currentPuzzle.answer);
            const maxLength = Math.max(guess.length, currentPuzzle.answer.length);
            const similarity = (maxLength - distance) / maxLength;
            if (similarity >= 0.9) { winGame(); } else { handleWrongGuess(guess); }
            guessInputEl.value = '';
        }

        function handleWrongGuess(guess) {
            if (wrongGuesses.includes(guess)) return;
            wrongGuesses.push(guess);
            wrongGuessesEl.textContent = `C√°c l·∫ßn ƒëo√°n sai: ${wrongGuesses.join(', ')}`;
            feedbackEl.textContent = 'Kh√¥ng ch√≠nh x√°c!';
            feedbackEl.classList.add('text-red-600');
            setTimeout(() => { feedbackEl.textContent = ''; feedbackEl.classList.remove('text-red-600'); }, 1500);
        }

        function handleRevealClue() { if (revealedCluesCount < 5) { revealedCluesCount++; render(); } }

        // NEW: Function to handle showing the answer
        function handleShowAnswer() {
            feedbackEl.innerHTML = `ƒê√°p √°n l√†: <strong class="capitalize">${currentPuzzle.answer}</strong>`;
            feedbackEl.classList.add('text-green-600');
            guessInputEl.disabled = true;
            guessButtonEl.disabled = true;
            revealClueButtonEl.disabled = true;
            showAnswerButtonEl.disabled = true;
        }

        function winGame() {
            let resultString = '';
            for (let i = 0; i < 5; i++) { resultString += (i < revealedCluesCount) ? 'üü©' : '‚¨úÔ∏è'; }
            resultGridEl.textContent = resultString;
            winModalEl.classList.remove('hidden'); winModalEl.classList.add('flex');
            guessInputEl.disabled = true; guessButtonEl.disabled = true; revealClueButtonEl.disabled = true;
            showAnswerButtonEl.disabled = true;
        }

        function shareResult() {
            const shareText = `T√¥i ƒë√£ gi·∫£i ƒë∆∞·ª£c Th·ª≠ Th√°ch Pinpoint! üß†\n\nCh·ªß ƒë·ªÅ: ${currentPuzzle.category}\nK·∫øt qu·∫£: ${resultGridEl.textContent}\n\nTh·ª≠ th√°ch b·∫£n th√¢n t·∫°i ƒë√¢y: https://brewjasmine.github.io/sudoku-challenge/pinpoint.html`;
            navigator.clipboard.writeText(shareText).then(() => {
                shareButtonEl.textContent = 'ƒê√£ sao ch√©p!';
                setTimeout(() => { shareButtonEl.textContent = 'Sao ch√©p & Chia s·∫ª'; }, 2000);
            });
        }

        guessButtonEl.addEventListener('click', handleGuess);
        guessInputEl.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleGuess(); });
        revealClueButtonEl.addEventListener('click', handleRevealClue);
        shareButtonEl.addEventListener('click', shareResult);
        playAgainButtonEl.addEventListener('click', initGame);
        showAnswerButtonEl.addEventListener('click', handleShowAnswer); // NEW: Add event listener

        initGame();
    </script>
</body>
</html>

